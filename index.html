<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Vocab Trainer — GitHub Fixed</title>
<script src="https://cdn.tailwindcss.com"></script>
<style>
  .word-row:hover { background: rgba(2,6,23,0.03); }
  .option-btn { transition: background .12s, transform .06s; }
  .option-btn:active { transform: translateY(1px); }
</style>
</head>
<body class="bg-gray-50 text-gray-900">
  <div class="max-w-6xl mx-auto p-6">
    <header class="mb-6">
      <h1 class="text-3xl font-bold">Vocab Trainer</h1>
      <p class="text-sm text-gray-600 mt-1">
        GitHub Pages version — JSON loaded with absolute HTTPS path.
      </p>
    </header>

    <section class="mb-4 flex gap-3 items-center">
      <input id="search" class="border p-2 rounded flex-1" placeholder="Search word, definition, sentence..." />
      <select id="posFilter" class="border p-2 rounded">
        <option value="">All POS</option>
      </select>
      <button id="newQuiz" class="bg-sky-600 text-white px-3 py-2 rounded">New Quiz</button>
      <div id="score" class="ml-4 text-sm">Score: <strong>0/0</strong></div>
      <button id="reset" class="ml-auto text-sm text-gray-600 underline">Reset</button>
    </section>

    <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
      <div class="md:col-span-2">
        <div class="mb-2 font-semibold">Words <span id="count" class="text-sm text-gray-600"></span></div>
        <div id="wordList" class="border rounded p-2 max-h-[65vh] overflow-auto bg-white"></div>
      </div>

      <aside>
        <div class="border rounded p-4 mb-4 bg-white">
          <h2 class="font-semibold mb-2">Details</h2>
          <div id="details" class="text-sm text-gray-700">Select a word to see details.</div>
        </div>

        <div class="border rounded p-4 bg-white">
          <h2 class="font-semibold mb-2">Quiz</h2>
          <div id="quizArea" class="text-sm text-gray-700">
            <div id="noQuiz">No active quiz. Click “New Quiz”.</div>
            <div id="quizPanel" style="display:none">
              <div class="text-gray-700">Fill in the blank:</div>
              <div id="blank" class="mt-2 font-medium"></div>
              <div id="options" class="mt-3 grid grid-cols-1 gap-2"></div>
              <div id="result" class="mt-3"></div>
            </div>
          </div>
        </div>

        <div class="text-xs text-gray-500 mt-4">
          Local storage keys: vocab_known_v1, vocab_progress_v1
        </div>
      </aside>
    </div>

    <footer class="mt-6 text-sm text-gray-600">
      Hosted on GitHub Pages. JSON loaded via absolute URL.
    </footer>
  </div>

<script>
(() => {
  // ABSOLUTE PATH FOR GITHUB PAGES
  const JSON_PATH = "https://u2024s.github.io/vocab/sat_vocab_clean2.json";

  const KNOWN_KEY = "vocab_known_v1";
  const PROGRESS_KEY = "vocab_progress_v1";

  let words = [];
  let known = loadJSON(KNOWN_KEY) || {};
  let progress = loadJSON(PROGRESS_KEY) || { correct: 0, total: 0 };
  let currentQuiz = null;

  const $ = sel => document.querySelector(sel);
  const elWordList = $("#wordList");
  const elCount = $("#count");
  const elPosFilter = $("#posFilter");
  const elSearch = $("#search");
  const elScore = $("#score strong");
  const elDetails = $("#details");
  const elNewQuiz = $("#newQuiz");
  const elReset = $("#reset");
  const elQuizPanel = $("#quizPanel");
  const elNoQuiz = $("#noQuiz");
  const elBlank = $("#blank");
  const elOptions = $("#options");
  const elResult = $("#result");

  function saveJSON(k, v) {
    localStorage.setItem(k, JSON.stringify(v));
  }
  function loadJSON(k) {
    try { return JSON.parse(localStorage.getItem(k)); }
    catch (e) { return null; }
  }

  function shuffle(arr) {
    for (let i=arr.length-1;i>0;i--) {
      const j = Math.floor(Math.random()*(i+1));
      [arr[i], arr[j]]=[arr[j], arr[i]];
    }
    return arr;
  }

  function escapeReg(s){
    return s.replace(/[.*+?^${}()|[\]\\]/g,'\\$&');
  }

  function buildIndexable(arr){
    return arr.map((w,i)=>({
      _id: i,
      word: (w.word||"").trim(),
      pos: (w.pos||"").trim(),
      definition: (w.definition||"").replace(/\s+/g," ").trim(),
      sentence: (w.sentence||"").replace(/\s+/g," ").trim()
    }));
  }

  function renderList(filtered){
    elWordList.innerHTML = "";
    filtered.forEach(w=>{
      const row = document.createElement("div");
      row.className = "p-2 border-b last:border-b-0 flex items-start gap-3 word-row";
      row.innerHTML = `
        <div class="w-24 font-mono">${w.word}</div>
        <div class="flex-1">
          <div class="text-sm"><em>${w.pos}</em> — ${w.definition}</div>
          <div class="text-xs text-gray-500 mt-1">${w.sentence}</div>
          <div class="mt-2 text-sm flex gap-2">
            <button class="view-btn underline">View</button>
            <button class="mark-btn">${known[w._id] ? "Unmark Known" : "Mark Known"}</button>
          </div>
        </div>
        <div>
          <input type="checkbox" class="known-chk" ${known[w._id]?"checked":""}>
        </div>
      `;
      row.querySelector(".view-btn").addEventListener("click", ()=>showDetails(w));
      row.querySelector(".mark-btn").addEventListener("click", ()=>{ toggleKnown(w._id); render(); });
      row.querySelector(".known-chk").addEventListener("change", ()=>{ toggleKnown(w._id); render(); });
      elWordList.appendChild(row);
    });
    elCount.textContent = `(${filtered.length})`;
  }

  function showDetails(w){
    elDetails.innerHTML = `
      <div class="text-xl font-bold">${w.word}</div>
      <div class="text-sm italic">${w.pos}</div>
      <div class="mt-2">${w.definition}</div>
      <div class="mt-2 text-gray-600">${w.sentence}</div>
      <div class="mt-3 flex gap-2">
        <button id="detailMark" class="px-3 py-1 bg-sky-600 text-white rounded">${known[w._id] ? "Unmark Known" : "Mark Known"}</button>
        <button id="detailClose" class="px-3 py-1 border rounded">Close</button>
      </div>
    `;
    $("#detailMark").addEventListener("click", ()=>{ toggleKnown(w._id); showDetails(w); render(); });
    $("#detailClose").addEventListener("click", ()=>{ elDetails.textContent="Select a word to see details."; });
  }

  function toggleKnown(id){
    if (known[id]) delete known[id];
    else known[id]=true;
    saveJSON(KNOWN_KEY, known);
  }

  function applyFilters(){
    const q = elSearch.value.trim().toLowerCase();
    const pos = elPosFilter.value;
    const filtered = words.filter(w=>{
      if(pos && w.pos!==pos) return false;
      if(!q) return true;
      return w.word.toLowerCase().includes(q) ||
             w.definition.toLowerCase().includes(q) ||
             w.sentence.toLowerCase().includes(q);
    });
    renderList(filtered);
  }

  function populatePOSOptions(arr){
    const set = new Set(arr.map(w=>w.pos).filter(Boolean));
    elPosFilter.innerHTML = '<option value="">All POS</option>' +
      Array.from(set).sort().map(o=>`<option value="${o}">${o}</option>`).join("");
  }

  function makeQuiz(){
    if(!words.length) return;
    const correct = words[Math.floor(Math.random()*words.length)];
    let blanked = correct.sentence;
    const pattern = new RegExp("\\b"+escapeReg(correct.word)+"\\b","i");
    if(pattern.test(blanked)){
      blanked = blanked.replace(pattern,"_____");
    } else {
      blanked = blanked.replace(/\b\w+\b/, "_____");
    }

    let pool = words.filter(w=>w._id!==correct._id && w.pos===correct.pos);
    shuffle(pool);
    let distractors = pool.slice(0,3).map(w=>w.word);
    if(distractors.length<3){
      let others = words.filter(w=>w._id!==correct._id);
      shuffle(others);
      distractors = distractors.concat(others.slice(0,3-distractors.length).map(w=>w.word));
    }

    const options = shuffle([correct.word, ...distractors]);
    currentQuiz = { correct, blanked, options };
    showQuiz();
  }

  function showQuiz(){
    if(!currentQuiz){
      elQuizPanel.style.display="none";
      elNoQuiz.style.display="block";
      return;
    }
    elNoQuiz.style.display="none";
    elQuizPanel.style.display="block";
    elBlank.textContent = currentQuiz.blanked;
    elOptions.innerHTML = "";
    elResult.innerHTML = "";
    currentQuiz.options.forEach(opt=>{
      const btn = document.createElement("button");
      btn.className = "option-btn p-2 border rounded";
      btn.textContent = opt;
      btn.addEventListener("click", ()=>answerQuiz(opt));
      elOptions.appendChild(btn);
    });
  }

  function answerQuiz(choice){
    const ok = choice.toLowerCase() === currentQuiz.correct.word.toLowerCase();
    elResult.innerHTML = `<div class="p-2 rounded ${ok?"bg-green-100":"bg-red-100"}">
      ${ok?"Correct!":"Incorrect — Answer: "+currentQuiz.correct.word}
    </div>`;
    progress.total++;
    if(ok) progress.correct++;
    saveJSON(PROGRESS_KEY, progress);
    elScore.textContent = `${progress.correct}/${progress.total}`;
  }

  async function init(){
    try{
      const r = await fetch(JSON_PATH);
      const data = await r.json();
      words = buildIndexable(data);
    } catch(e){
      console.error("Failed to load JSON", e);
      words = [];
    }

    populatePOSOptions(words);
    applyFilters();
    elScore.textContent = `${progress.correct}/${progress.total}`;
  }

  elSearch.addEventListener("input", applyFilters);
  elPosFilter.addEventListener("change", applyFilters);
  elNewQuiz.addEventListener("click", makeQuiz);
  elReset.addEventListener("click", ()=>{
    if(confirm("Reset progress and known words?")){
      known = {};
      progress = {correct:0,total:0};
      saveJSON(KNOWN_KEY,known);
      saveJSON(PROGRESS_KEY,progress);
      elScore.textContent = "0/0";
      applyFilters();
    }
  });

  function render(){ applyFilters(); }

  init();
})();
</script>
</body>
</html>
