<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Vocab Trainer — Full (no React)</title>
<script src="https://cdn.tailwindcss.com"></script>
<style>
  /* small tweaks */
  .word-row:hover { background: rgba(2,6,23,0.03); }
  .option-btn { transition: background .12s, transform .06s; }
  .option-btn:active { transform: translateY(1px); }
</style>
</head>
<body class="bg-gray-50 text-gray-900">
  <div class="max-w-6xl mx-auto p-6">
    <header class="mb-6">
      <h1 class="text-3xl font-bold">Vocab Trainer</h1>
      <p class="text-sm text-gray-600 mt-1">Single-file, no build tools. Place <code>sat_vocab_clean2.json</code> in the same folder as this file and refresh to load the full list.</p>
    </header>

    <section class="mb-4 flex gap-3 items-center">
      <input id="search" class="border p-2 rounded flex-1" placeholder="Search word, definition, sentence..." />
      <select id="posFilter" class="border p-2 rounded">
        <option value="">All POS</option>
      </select>
      <button id="newQuiz" class="bg-sky-600 text-white px-3 py-2 rounded">New Quiz</button>
      <div id="score" class="ml-4 text-sm">Score: <strong>0/0</strong></div>
      <button id="reset" class="ml-auto text-sm text-gray-600 underline">Reset</button>
    </section>

    <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
      <div class="md:col-span-2">
        <div class="mb-2 font-semibold">Words <span id="count" class="text-sm text-gray-600"></span></div>
        <div id="wordList" class="border rounded p-2 max-h-[65vh] overflow-auto bg-white"></div>
      </div>
      <aside>
        <div class="border rounded p-4 mb-4 bg-white">
          <h2 class="font-semibold mb-2">Details</h2>
          <div id="details" class="text-sm text-gray-700">Select a word to see details.</div>
        </div>

        <div class="border rounded p-4 bg-white">
          <h2 class="font-semibold mb-2">Quiz</h2>
          <div id="quizArea" class="text-sm text-gray-700">
            <div id="noQuiz">No active quiz. Click “New Quiz”.</div>
            <div id="quizPanel" style="display:none">
              <div class="text-gray-700">Fill in the blank:</div>
              <div id="blank" class="mt-2 font-medium"></div>
              <div id="options" class="mt-3 grid grid-cols-1 gap-2"></div>
              <div id="result" class="mt-3"></div>
            </div>
          </div>
        </div>

        <div class="text-xs text-gray-500 mt-4">Local storage keys: <code>vocab_known_v1</code>, <code>vocab_progress_v1</code></div>
      </aside>
    </div>

    <footer class="mt-6 text-sm text-gray-600">If the vocab file doesn't load, open the folder where this page is and place <code>sat_vocab_clean2.json</code> next to this file and refresh.</footer>
  </div>

<script>
(() => {
  const JSON_PATH = './sat_vocab_clean2.json';
  const KNOWN_KEY = 'vocab_known_v1';
  const PROGRESS_KEY = 'vocab_progress_v1';

  let words = [];
  let known = loadJSON(KNOWN_KEY) || {}; // map id -> true
  let progress = loadJSON(PROGRESS_KEY) || {correct:0, total:0};
  let currentQuiz = null;

  const $ = sel => document.querySelector(sel);
  const $$ = sel => Array.from(document.querySelectorAll(sel));

  const elWordList = $('#wordList');
  const elCount = $('#count');
  const elPosFilter = $('#posFilter');
  const elSearch = $('#search');
  const elScore = $('#score strong');
  const elDetails = $('#details');
  const elNewQuiz = $('#newQuiz');
  const elReset = $('#reset');
  const elQuizPanel = $('#quizPanel');
  const elNoQuiz = $('#noQuiz');
  const elBlank = $('#blank');
  const elOptions = $('#options');
  const elResult = $('#result');

  function setScore(){ elScore.textContent = `${progress.correct}/${progress.total}`; saveJSON(PROGRESS_KEY, progress); }

  function saveJSON(k, v){ try{ localStorage.setItem(k, JSON.stringify(v)); }catch(e){console.warn('localStorage', e);} }
  function loadJSON(k){ try{ const s=localStorage.getItem(k); return s?JSON.parse(s):null;}catch(e){return null;} }

  function shuffle(arr){ for(let i=arr.length-1;i>0;i--){ const j=Math.floor(Math.random()*(i+1)); [arr[i],arr[j]]=[arr[j],arr[i]] } return arr; }
  function escapeReg(s){ return s.replace(/[.*+?^${}()|[\]\\]/g,'\\\\$&'); }

  function renderList(filtered){
    elWordList.innerHTML = '';
    filtered.forEach(w => {
      const row = document.createElement('div');
      row.className = 'p-2 border-b last:border-b-0 flex items-start gap-3 word-row';
      row.innerHTML = `
        <div class="w-24 font-mono">${w.word}</div>
        <div class="flex-1">
          <div class="text-sm text-gray-700"><em>${w.pos||''}</em> — ${w.definition||''}</div>
          <div class="text-xs text-gray-500 mt-1">${w.sentence||''}</div>
          <div class="mt-2 text-sm flex gap-2">
            <button class="text-sm view-btn">View</button>
            <button class="text-sm mark-btn">${known[w._id]? 'Unmark Known' : 'Mark Known'}</button>
          </div>
        </div>
        <div class="text-right">
          <input type="checkbox" class="known-chk" ${known[w._id]? 'checked' : ''} aria-label="Known ${w.word}" />
        </div>
      `;
      // attach events
      row.querySelector('.view-btn').addEventListener('click', ()=> showDetails(w));
      row.querySelector('.mark-btn').addEventListener('click', ()=> { toggleKnown(w._id); render(); });
      row.querySelector('.known-chk').addEventListener('change', (e)=> { toggleKnown(w._id); render(); });
      elWordList.appendChild(row);
    });
    elCount.textContent = `(${filtered.length})`;
  }

  function showDetails(w){
    elDetails.innerHTML = `
      <div class="text-xl font-bold">${w.word}</div>
      <div class="text-sm italic">${w.pos||''}</div>
      <div class="mt-2">${w.definition||''}</div>
      <div class="mt-2 text-gray-600">${w.sentence||''}</div>
      <div class="mt-3 flex gap-2">
        <button id="detailMark" class="px-3 py-1 bg-sky-600 text-white rounded">${known[w._id]? 'Unmark Known':'Mark Known'}</button>
        <button id="detailClose" class="px-3 py-1 border rounded">Close</button>
      </div>
    `;
    $('#detailMark').addEventListener('click', ()=> { toggleKnown(w._id); showDetails(w); render(); });
    $('#detailClose').addEventListener('click', ()=> { elDetails.textContent = 'Select a word to see details.'; });
  }

  function toggleKnown(id){
    if(known[id]) delete known[id]; else known[id]=true;
    saveJSON(KNOWN_KEY, known);
  }

  function buildIndexable(arr){
    // ensure each word has a stable _id and normalized fields
    return arr.map((w,i)=>{
      const clean = {
        _id: i,
        word: (w.word||'').trim(),
        pos: (w.pos||'').trim(),
        definition: (w.definition||'').replace(/\\s+/g,' ').trim(),
        sentence: (w.sentence||'').replace(/\\s+/g,' ').trim()
      };
      return clean;
    });
  }

  function populatePOSOptions(arr){
    const set = new Set(arr.map(w=>w.pos).filter(Boolean));
    const opts = Array.from(set).sort();
    elPosFilter.innerHTML = '<option value=\"\">All POS</option>' + opts.map(o=>`<option value="${o}">${o}</option>`).join('');
  }

  function applyFilters(){ 
    const q = elSearch.value.trim().toLowerCase();
    const pos = elPosFilter.value;
    const filtered = words.filter(w=>{
      if(pos && w.pos!==pos) return false;
      if(!q) return true;
      return (w.word||'').toLowerCase().includes(q) || (w.definition||'').toLowerCase().includes(q) || (w.sentence||'').toLowerCase().includes(q);
    });
    renderList(filtered);
  }

  function makeQuiz(){
    if(!words.length) return;
    const correct = words[Math.floor(Math.random()*words.length)];
    // create blanked sentence
    let blanked = (correct.sentence || '');
    const pattern = new RegExp('\\b'+escapeReg(correct.word)+'\\b','i');
    if(pattern.test(blanked)){
      blanked = blanked.replace(pattern, '_____');
    } else {
      // fallback: remove first occurrence of word characters from sentence
      blanked = blanked.replace(new RegExp(escapeReg(correct.word.split(' ')[0]), 'i'), '_____');
    }
    // gather distractors same POS
    let pool = words.filter(w=>w._id!==correct._id && (w.pos||'')===(correct.pos||''));
    shuffle(pool);
    let distractors = pool.slice(0,3).map(w=>w.word);
    // if not enough same-POS distractors, fill with random others
    if(distractors.length < 3){
      const others = words.filter(w=>w._id!==correct._id && !distractors.includes(w.word));
      shuffle(others);
      distractors = distractors.concat(others.slice(0, 3 - distractors.length).map(w=>w.word));
    }
    const options = shuffle([correct.word, ...distractors]);
    currentQuiz = {correct, blanked, options};
    showQuiz();
  }

  function showQuiz(){
    if(!currentQuiz){ elNoQuiz.style.display='block'; elQuizPanel.style.display='none'; return; }
    elNoQuiz.style.display='none'; elQuizPanel.style.display='block'; elBlank.textContent = currentQuiz.blanked;
    elOptions.innerHTML = '';
    elResult.innerHTML = '';
    currentQuiz.options.forEach(opt=>{
      const btn = document.createElement('button');
      btn.className = 'option-btn p-2 border rounded text-left w-full';
      btn.textContent = opt;
      btn.addEventListener('click', ()=> answerQuiz(opt, btn));
      elOptions.appendChild(btn);
    });
  }

  function answerQuiz(choice, btn){
    const ok = choice.toLowerCase() === (currentQuiz.correct.word||'').toLowerCase();
    // show immediate feedback
    elResult.innerHTML = '';
    const msg = document.createElement('div');
    msg.className = 'p-2 rounded ' + (ok? 'bg-green-100' : 'bg-red-100');
    msg.textContent = ok? 'Correct!' : `Incorrect — Answer: ${currentQuiz.correct.word}`;
    elResult.appendChild(msg);
    progress.total += 1;
    if(ok) progress.correct += 1;
    setScore();
    saveJSON(PROGRESS_KEY, progress);
  }

  // initial load
  async function init(){
    try{
      const r = await fetch(JSON_PATH);
      if(!r.ok) throw new Error('not found');
      const data = await r.json();
      words = buildIndexable(data);
    }catch(e){
      // fallback: small built-in sample
      words = buildIndexable([
        {word:'abate',pos:'v',definition:'to reduce, lessen',sentence:'The rain poured down for a while, then abated.'},
        {word:'benevolent',pos:'adj',definition:'marked by goodness or doing good',sentence:'The benevolent donor paid for the scholarships.'},
        {word:'capricious',pos:'adj',definition:'subject to whim, fickle',sentence:'The manager's capricious decisions confused staff.'}
      ]);
      console.warn('Could not load external JSON, using sample', e);
    }
    populatePOSOptions(words);
    applyFilters();
    setScore();
  }

  // events
  elSearch.addEventListener('input', applyFilters);
  elPosFilter.addEventListener('change', applyFilters);
  elNewQuiz.addEventListener('click', ()=>{ makeQuiz(); });
  elReset.addEventListener('click', ()=>{
    if(confirm('Reset progress and known words?')){
      known = {}; progress = {correct:0,total:0}; saveJSON(KNOWN_KEY, known); saveJSON(PROGRESS_KEY, progress); setScore(); applyFilters();
    }
  });

  // expose render so toggles update UI properly
  function render(){ applyFilters(); }

  // run
  init();

  // expose globally for debugging (optional)
  window.__vocabTrainer = { makeQuiz, render };

})();
</script>
</body>
</html>
